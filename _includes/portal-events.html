<template id="template-portal-event-snippet" style="display:none;">
  <div class="row">
    <div class="medium-4 columns t10">
      <a href="--URL--" target="_blank">
        <img src="--IMG--" onerror="this.src='{{ 'bps-classroom-big.jpg' | imgurl,size:'medium' }}'">
      </a>
    </div>
    <div class="medium-8 columns">
      <a href="--URL--" target="_blank">
        <h3 class="t10">
          <small class="subheader">--SUBHEADER--</small><br>
          --HEADER--
        </h3>
      </a>
      <p>--EXCERPT--</p>
      <p>
        <a href="--URL--" target="_blank">Read More&nbsp;â€º</a>
      </p>
    </div>
  </div>
</template>
<template id="template-portal-no-events" style="display:none;">
  <div class="text-center">
    <br/>
    <p>No upcoming courses found... But!<br/>You can join our ongoing courses.</p>
    <p><a href="/courses">Check out all our courses here</a></p>
  </div>
</template>

<div class="row cols_s-1 cols_m-1 cols-1 cols-left-2">
  <div class="columns small-12 medium-12 large-12">
    <div id="portal-events">
      <p class="text-center"><br/>Loading...</p>
    </div>
  </div>
</div>

  <script>
    (function() {
      function renderPortalEvents() {
        var template = $('#template-portal-event-snippet');
        var eventsWrapper = $('#portal-events');
        /* Load events */
        $.getJSON('https://us-central1-custportal-3000.cloudfunctions.net/api/data/events', function(events) {
          eventsWrapper.html('');
          events = events.sort(function(a,b) {return a.start_date < b.start_date && 1 || -1});
          if (events.length === 0) {
            eventsWrapper.append($('#template-portal-no-events').html());
            return;
          }
          if ({{include.randomize}}) {
            events.sort(function(a,b) {return Math.random() > 0.5 && 1 || -1});
          }
          /* Loop thru single events and render row item */
          for (var i = 0, l = events.length; i<Math.min(l, {{include.limit}}); ++i) {
            var event = events[i];
            var el = template.html()
              .replace(/--URL--/g, 'https://portal.blackpepperswing.com/courses/' + event.id)
              .replace(/--IMG--/g, event.meta.image_src)
              .replace(/--SUBHEADER--/g, new Date(event.start_date).toLocaleDateString('FI') + ' - ' + new Date(event.last_date).toLocaleDateString('FI') + ', ' + event.meta.duration)
              .replace(/--HEADER--/g, event.name)
              .replace(/--EXCERPT--/g, event.meta.description);
            eventsWrapper.append(el);
          }
        });
      }
      /* Wait for jQuery to load */
      var at = 100;
      var a = setInterval( function() {
        if ( typeof window.jQuery === 'undefined' ) {
          at = Math.min(1000, at*2);
          return;
        }
        clearInterval( a );
        renderPortalEvents();
      }, at );
    })();
  </script>
